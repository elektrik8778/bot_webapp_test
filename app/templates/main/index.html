<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../../static/css/fonts.css"></link>
    <title>{{ title }}</title>
</head>
<body>
<main class="container-fluid" style="min-height: 100vh; background-color: black; font-family: '8BIT WONDER'">
    <section id="greeting" class="text-center pt-2">
        <span id="greeting-text" class="nes-text is-primary"></span>
    </section>
    <section id="achieves" class="text-center pt-2" hidden>
{#        <i class="nes-icon is-large star is-transparent"></i>#}
{#        <i class="nes-icon is-large star is-transparent"></i>#}
{#        <i class="nes-icon is-large star is-transparent"></i>#}
{#        <i class="nes-icon is-large star is-transparent"></i>#}
{#        <i class="nes-icon is-large star is-transparent"></i>#}
{#        <i class="nes-icon trophy is-large"></i>#}
{#        <i class="nes-icon trophy is-large"></i>#}
{#        <i class="nes-icon trophy is-large"></i>#}
{#        <i class="nes-icon trophy is-large"></i>#}
{#        <i class="nes-icon trophy is-large"></i>#}
    </section>
    <section id="pers-wrapper" style="height: 30vh; display: flex">
        <i id="pers" class="nes-octocat animate text-center" style="margin: auto"></i>
        <div id="pers-is-absent" class="message -left" style="margin: auto">
            <div class="nes-balloon from-left is-dark">
              <p>вы ушли проходить квест</p>
            </div>
            <i class="nes-bcrikko"></i>
        </div>
    </section>
    <section id="controls">
        <div class="row text-center">
            <div class="col-6">
                <a id="start-quest" class="nes-btn is-success" href="#" style="text-decoration: none">Пройти квест</a>
            </div>
            <div class="col-6">
                <a id="final-battle" class="nes-btn is-error" href="#" style="text-decoration: none">Финальная битва</a>
            </div>
        </div>
    </section>
</main>
<script>
    const bot = Telegram.WebApp;

    if (bot.initDataUnsafe.user)
        if (localStorage.uid === undefined || localStorage.uid !== bot.initDataUnsafe.user.id)
            localStorage.uid = bot.initDataUnsafe.user.id

    let uid = localStorage.uid;
    initPers()

    $('#start-quest').click(startQuest)
    $('#final-battle').click(finalBattle)

    async function initPers() {
        let response =  await fetch(`/check_quest_process/${uid}`);
        if (response.status === 200) {
            $('#pers').hide()
            $('#pers-is-absent').show()
            $('#start-quest').hide()
            $('#final-battle').hide()
        }
        else {
            $('#pers').show()
            $('#pers-is-absent').hide()
            $('#start-quest').show()
            $('#final-battle').show()
        }

        let currentUser =  await fetch(`/get_user/${uid}`);
        if (currentUser.ok) {
            currentUser.text().then(txt=>{
                $('#greeting-text').text(`Привет, ${txt}!`)
            })
        }

        let components = await fetch(`/get_components/${uid}`)
        components.json().then(result=>{
            let achieves = $('#achieves')
            if (result) achieves.empty()
            for (let c of result) {
                console.log(c)
                achieves.append(`
    <div style="max-width: 18%; display: inline-grid">
        <p class="mb-0" "><i class="nes-icon is-large trophy"></i></p>
        <p class="mt-0" style="font-size: 6px; color: white;">${c.name}</p>
    </div>
`)
            }
            achieves.removeAttr('hidden')
        })
    }
    function startQuest() {
        fetch(`/quest/${uid}`).then(result=>{
            console.log(result.text())
        })
        bot.close()
    }
    function finalBattle() {
        fetch(`/final_battle/${uid}`).then(result=>{
            console.log(result.text())
        })
        bot.close()
        bot.close()
    }

</script>
</body>
</html>
