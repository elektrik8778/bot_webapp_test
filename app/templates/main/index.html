<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#fff">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="../../static/css/nes.min.css" rel="stylesheet"/>
    <link href="../../static/css/bootstrap.min.css" rel="stylesheet">
    <script src="../../static/js/bootstrap.bundle.min"></script>
    <script src="../../static/js/chart.min"></script>
    <link rel="stylesheet" href="../../static/css/fonts.css"></link>
    <title>{{ title }}</title>
</head>
<body style="box-sizing: border-box">
<main class="container-fluid" style="min-height: 100vh;
        background-image: url('{{ url_for('static', filename='images/castle_page/background.jpg') }}');
        background-repeat: repeat-y;
        background-size: cover;
        font-family: 'TT Positive';">
    <section id="greeting" class="text-center pt-2">
        <span id="greeting-text" class="nes-text is-primary"></span>
    </section>
    <section id="achieves" class="row" hidden></section>
    <section id="pers-wrapper" style="height: 25vh; display: flex">
{#        <i id="pers" class="nes-octocat animate text-center" style="margin: auto" hidden></i>#}
        <div id="pers" style="
                margin: auto;
                height: 150px;
                width: 150px;
                background-image: url('{{ url_for('static', filename='images/components/pocemonball.png') }}');
                background-size: cover;
                background-repeat: no-repeat;
                "></div>
    </section>
    <section id="controls">
        <div class="row text-center">
            <div class="col-6" style="display: none">
                <a id="start-quest" class="nes-btn is-success" href="#" style="text-decoration: none">Пройти квест</a>
            </div>
            <div id="final-battle-btn-wrapper" class="col-12" hidden>
                <a id="final-battle" class="nes-btn is-error" href="#" style="text-decoration: none; font-family: '8BIT WONDER'; width: 90%;">Финальная битва</a>
            </div>
        </div>
    </section>
</main>
<script>
    const bot = Telegram.WebApp;

    if (bot.initDataUnsafe.user)
        if (localStorage.uid === undefined || localStorage.uid !== bot.initDataUnsafe.user.id)
            localStorage.uid = bot.initDataUnsafe.user.id

    let uid = localStorage.uid;
    initPers()

    let startQuestBtn = document.querySelector('#start-quest')
    let finalBattleBtn = document.querySelector('#final-battle')
    startQuestBtn.addEventListener('click', startQuest)
    finalBattleBtn.addEventListener('click', finalBattle)

    async function initPers() {
        {#let response =  await fetch(`/check_quest_process/${uid}`);#}
        {#if (response.status === 200) {#}
        {#    document.querySelector('#pers-is-absent').removeAttribute('hidden')#}
        {#    startQuestBtn.style.display = 'none';#}
        {#    finalBattleBtn.style.display = 'none';}#}
        {#else {#}
        {#    document.querySelector('#pers').removeAttribute('hidden')#}
        {#    startQuestBtn.style.display = 'inline-block';#}
        {#    finalBattleBtn.style.display = 'inline-block';}#}

        {# подгрузка имени пользовтеля и приветствия #}
        {#let currentUser =  await fetch(`/get_user/${uid}`);#}
        {#if (currentUser.ok) {#}
        {#    currentUser.text().then(txt=>{#}
        {#        document.querySelector('#greeting-text').textContent = `Привет, ${txt}!`#}
        {#    })}#}

        let components = await fetch(`/get_components/${uid}`)
        components.json().then(result=>{
            let achieves = document.querySelector('#achieves')
            if (result) {
                achieves.innerHTML = ''
                if (result.length > 0)
                    document.querySelector('#final-battle-btn-wrapper').removeAttribute('hidden')
            }
            for (let c of result) {
                let achieve_wrapper_wrapper = document.createElement('div')
                achieve_wrapper_wrapper.classList.add('col-4')
                achieve_wrapper_wrapper.style.padding = '1%'

                let achieve_wrapper = document.createElement('div')
                achieve_wrapper.style.background = 'rgba(255,255,255,.5)'
                achieve_wrapper.style.borderRadius = '10px'
                achieve_wrapper.style.textAlign = 'center'
                achieve_wrapper.style.height = '125px'
                {#achieve_wrapper.style.paddingBottom = '1px'#}
                achieve_wrapper.classList.add('achieve-wrapper')

                let achieve_pic = document.createElement('div')
                achieve_pic.style.width = '80px'
                achieve_pic.style.height = '80px'
                achieve_pic.style.backgroundImage = 'url({{ url_for('static', filename='images/components/') }}'+c.filename+')'
                achieve_pic.style.backgroundSize = 'contain'
                achieve_pic.style.marginLeft = 'auto'
                achieve_pic.style.marginRight = 'auto'

                let achieve_descr = document.createElement('p');
                achieve_descr.style.marginLeft = '4%'
                achieve_descr.style.marginRight = '4%'
                achieve_descr.style.paddingLeft = '4%'
                achieve_descr.style.paddingRight = '4%'
                achieve_descr.classList.add('mt-0');
                achieve_descr.style.fontSize = '10px';
                achieve_descr.style.color = 'white';
                achieve_descr.style.lineHeight = '11px'
                achieve_descr.style.marginTop = 'auto';
                achieve_descr.style.marginBottom = 'auto';
                achieve_descr.textContent = c.name;
                achieves.append(achieve_wrapper_wrapper)
                achieve_wrapper.append(achieve_pic, achieve_descr)
                achieve_wrapper_wrapper.append(achieve_wrapper)
                {#achieve_pic_wrapper.append(achieve_pic)#}

            }
            achieves.removeAttribute('hidden')
        })
    }
    function startQuest() {
        fetch(`/quest/${uid}`).then(result=>{
            console.log(result.text())
        })
        bot.close()
    }
    function finalBattle() {
        fetch(`/final_battle/${uid}`).then(result=>{
            console.log(result.text())
        })
        bot.close()
        bot.close()
    }

</script>
</body>
</html>
