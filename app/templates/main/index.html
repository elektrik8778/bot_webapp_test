<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#fff">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="../../static/css/nes.min.css" rel="stylesheet"/>
    <link href="../../static/css/bootstrap.min.css" rel="stylesheet">
    <script src="../../static/js/bootstrap.bundle.min"></script>
    <script src="../../static/js/chart.min"></script>
    <link rel="stylesheet" href="../../static/css/fonts.css"></link>
    <title>{{ title }}</title>
</head>
<body>
<main class="container-fluid" style="min-height: 100vh; background-color: black; font-family: '8BIT WONDER'">
    <section id="greeting" class="text-center pt-2">
        <span id="greeting-text" class="nes-text is-primary"></span>
    </section>
    <section id="achieves" class="text-center pt-2" hidden></section>
    <section id="pers-wrapper" style="height: 30vh; display: flex">
        <i id="pers" class="nes-octocat animate text-center" style="margin: auto" hidden></i>
        <div id="pers-is-absent" class="message -left" style="margin: auto" hidden>
            <div class="nes-balloon from-left is-dark">
              <p>вы ушли проходить квест</p>
            </div>
            <i class="nes-bcrikko"></i>
        </div>
    </section>
    <section id="controls">
        <div class="row text-center">
            <div class="col-6">
                <a id="start-quest" class="nes-btn is-success" href="#" style="text-decoration: none">Пройти квест</a>
            </div>
            <div class="col-6">
                <a id="final-battle" class="nes-btn is-error" href="#" style="text-decoration: none">Финальная битва</a>
            </div>
        </div>
    </section>
</main>
<script>
    const bot = Telegram.WebApp;

    if (bot.initDataUnsafe.user)
        if (localStorage.uid === undefined || localStorage.uid !== bot.initDataUnsafe.user.id)
            localStorage.uid = bot.initDataUnsafe.user.id

    let uid = localStorage.uid;
    initPers()

    let startQuestBtn = document.querySelector('#start-quest')
    let finalBattleBtn = document.querySelector('#final-battle')
    startQuestBtn.addEventListener('click', startQuest)
    finalBattleBtn.addEventListener('click', finalBattle)

    async function initPers() {
        let response =  await fetch(`/check_quest_process/${uid}`);
        if (response.status === 200) {
            document.querySelector('#pers-is-absent').removeAttribute('hidden')
            startQuestBtn.style.display = 'none';
            finalBattleBtn.style.display = 'none';
        }
        else {
            document.querySelector('#pers').removeAttribute('hidden')
            startQuestBtn.style.display = 'inline-block';
            finalBattleBtn.style.display = 'inline-block';
        }

        let currentUser =  await fetch(`/get_user/${uid}`);
        if (currentUser.ok) {
            currentUser.text().then(txt=>{
                document.querySelector('#greeting-text').textContent = `Привет, ${txt}!`
            })
        }

        let components = await fetch(`/get_components/${uid}`)
        components.json().then(result=>{
            let achieves = document.querySelector('#achieves')
            if (result) achieves.innerHTML = ''
            for (let c of result) {
                let achieve_wrapper = document.createElement('div')
                achieve_wrapper.style.maxWidth = '18%';
                achieve_wrapper.style.marginRight = '3px';
                achieve_wrapper.style.display = 'inline-grid';
                let achieve_pic_wrapper = document.createElement('p');
                achieve_pic_wrapper.classList.add('mb-0');
                let achieve_pic = document.createElement('i');
                achieve_pic.classList.add('nes-icon', 'is-large', 'trophy');
                let achieve_descr = document.createElement('p');
                achieve_descr.classList.add('mt-0');
                achieve_descr.style.fontSize = '6px';
                achieve_descr.style.color = 'white';
                achieve_descr.textContent = c.name;
                achieves.append(achieve_wrapper)
                achieve_wrapper.append(achieve_pic_wrapper, achieve_descr)
                achieve_pic_wrapper.append(achieve_pic)
            }
            achieves.removeAttribute('hidden')
        })
    }
    function startQuest() {
        fetch(`/quest/${uid}`).then(result=>{
            console.log(result.text())
        })
        bot.close()
    }
    function finalBattle() {
        fetch(`/final_battle/${uid}`).then(result=>{
            console.log(result.text())
        })
        bot.close()
        bot.close()
    }
</script>
</body>
</html>
